<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lifting Tracker</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Track your lifting progress and body weight">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lifting">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // SheetsDbClient - inline implementation for CDN-based app
        class SheetsDbError extends Error {
            constructor(message, status, response) {
                super(message);
                this.name = 'SheetsDbError';
                this.status = status;
                this.response = response;
            }
        }

        class SheetsDbClient {
            constructor(options) {
                this.baseUrl = options.baseUrl.replace(/\/$/, '');
                this.spreadsheetId = options.spreadsheetId;
            }

            async request(path, options = {}) {
                const url = `${this.baseUrl}${path}`;
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Spreadsheet-Id': this.spreadsheetId,
                    ...options.headers,
                };

                const response = await fetch(url, { ...options, headers });

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch {
                        errorData = await response.text();
                    }
                    const message = errorData?.error || `Request failed with status ${response.status}`;
                    throw new SheetsDbError(message, response.status, errorData);
                }

                if (response.status === 204) return undefined;
                return response.json();
            }

            async health() {
                const response = await fetch(`${this.baseUrl}/health`);
                return response.json();
            }

            async listSheets() {
                const result = await this.request('/sheets');
                return result.sheets;
            }

            async getRows(sheetName) {
                const result = await this.request(`/sheets/${encodeURIComponent(sheetName)}/rows`);
                return result.rows;
            }

            async createRow(sheetName, data) {
                return this.request(`/sheets/${encodeURIComponent(sheetName)}/rows`, {
                    method: 'POST',
                    body: JSON.stringify(data),
                });
            }

            async updateRow(sheetName, rowIndex, data) {
                return this.request(`/sheets/${encodeURIComponent(sheetName)}/rows/${rowIndex}`, {
                    method: 'PUT',
                    body: JSON.stringify(data),
                });
            }

            async deleteRow(sheetName, rowIndex) {
                return this.request(`/sheets/${encodeURIComponent(sheetName)}/rows/${rowIndex}`, {
                    method: 'DELETE',
                });
            }

            async createSheet(sheetName) {
                return this.request('/sheets', {
                    method: 'POST',
                    body: JSON.stringify({ name: sheetName }),
                });
            }
        }

        // Lucide icons as inline SVG components
        const Dumbbell = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m6.5 6.5 11 11"></path>
                <path d="m21 21-1-1"></path>
                <path d="m3 3 1 1"></path>
                <path d="m18 22 4-4"></path>
                <path d="m2 6 4-4"></path>
                <path d="m3 10 7-7"></path>
                <path d="m14 21 7-7"></path>
            </svg>
        );

        const Send = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const RefreshCw = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        );

        function LiftingTracker() {
            const [formData, setFormData] = useState({
                exercise: '',
                weight: '',
                percentage: '',
                reps: '',
                notes: ''
            });
            const [status, setStatus] = useState('');
            const apiBaseUrl = 'https://sheetsapi-g56q77hy2a-uc.a.run.app';
            const [spreadsheetId, setSpreadsheetId] = useState(
                localStorage.getItem('liftingSpreadsheetId') || ''
            );
            const [liftingData, setLiftingData] = useState([]);
            const [exercises, setExercises] = useState([]);
            const [routines, setRoutines] = useState([]);
            const [selectedRoutine, setSelectedRoutine] = useState('');
            const [loading, setLoading] = useState(false);
            const [activeTab, setActiveTab] = useState(
                localStorage.getItem('liftingSpreadsheetId') ? 'track' : 'settings'
            );
            const [progressView, setProgressView] = useState('chart');
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Exercise editor state
            const [editingExercise, setEditingExercise] = useState(null);
            const [exerciseForm, setExerciseForm] = useState({
                Exercise: '',
                '100pct': '',
                '90pct': '',
                '80pct': '',
                '70pct': '',
                '60pct': '',
                Warmup: ''
            });
            const [isAddingExercise, setIsAddingExercise] = useState(false);

            // Routine editor state
            const [editingRoutineItem, setEditingRoutineItem] = useState(null);
            const [routineForm, setRoutineForm] = useState({
                Routine: '',
                Exercise: '',
                Percentage: '',
                Reps: ''
            });
            const [isAddingRoutineItem, setIsAddingRoutineItem] = useState(false);
            const [showRoutineSuggestions, setShowRoutineSuggestions] = useState(false);

            // Weight tracking state
            const [bodyWeight, setBodyWeight] = useState('');
            const [weightHistory, setWeightHistory] = useState([]);
            const weightChartRef = useRef(null);
            const weightChartInstance = useRef(null);

            // Required sheets configuration
            const REQUIRED_SHEETS = {
                exercises: {
                    columns: ['id', 'Exercise', '100pct', '90pct', '80pct', '70pct', '60pct', 'Warmup', 'LastUpdated']
                },
                routines: {
                    columns: ['id', 'Routine', 'Exercise', 'Percentage', 'Reps']
                },
                sets: {
                    columns: ['id', 'Date', 'Routine', 'Exercise', 'Percentage', 'Weight', 'Reps', 'Notes', 'TotalWeight']
                },
                weight: {
                    columns: ['id', 'Date', 'Weight']
                }
            };

            const [initializing, setInitializing] = useState(false);
            const [editingSettings, setEditingSettings] = useState(false);
            const [tempSpreadsheetId, setTempSpreadsheetId] = useState('');
            const [setupInputId, setSetupInputId] = useState('');

            const createClient = () => {
                if (!apiBaseUrl || !spreadsheetId) return null;
                return new SheetsDbClient({ baseUrl: apiBaseUrl, spreadsheetId });
            };

            // Initialize sheets - create any missing required sheets
            const initializeSheets = async () => {
                const client = createClient();
                if (!client) return { success: false, error: 'No client' };

                setInitializing(true);
                try {
                    // Get list of existing sheets
                    const existingSheets = await client.listSheets();
                    const existingNames = existingSheets.map(s => s.title);

                    const missingSheets = Object.keys(REQUIRED_SHEETS).filter(
                        name => !existingNames.includes(name)
                    );

                    if (missingSheets.length === 0) {
                        setInitializing(false);
                        return { success: true, created: [] };
                    }

                    setStatus(`üìù Creating ${missingSheets.length} missing sheet(s)...`);

                    // Create each missing sheet
                    for (const sheetName of missingSheets) {
                        await client.createSheet(sheetName);
                        // Add a placeholder row to establish headers, then delete it
                        const placeholderRow = {};
                        REQUIRED_SHEETS[sheetName].columns.forEach(col => {
                            placeholderRow[col] = col === 'id' ? 'placeholder' : '';
                        });
                        await client.createRow(sheetName, placeholderRow);
                        await client.deleteRow(sheetName, 2); // Delete the placeholder row
                    }

                    setStatus(`‚úì Created sheets: ${missingSheets.join(', ')}`);
                    setTimeout(() => setStatus(''), 3000);
                    setInitializing(false);
                    return { success: true, created: missingSheets };
                } catch (error) {
                    console.error('Error initializing sheets:', error);
                    setStatus(`‚ùå Error creating sheets: ${error.message}`);
                    setInitializing(false);
                    return { success: false, error: error.message };
                }
            };

            const fetchExercises = async () => {
                const client = createClient();
                if (!client) return;

                try {
                    const rows = await client.getRows('exercises');
                    setExercises(rows || []);
                } catch (error) {
                    console.error('Error fetching exercises:', error);
                }
            };

            const fetchRoutines = async () => {
                const client = createClient();
                if (!client) return;

                try {
                    const rows = await client.getRows('routines');
                    setRoutines(rows || []);
                } catch (error) {
                    console.error('Error fetching routines:', error);
                }
            };

            // Get unique routine names from routines data
            const getUniqueRoutines = () => {
                const routineNames = routines.map(r => r.Routine);
                return [...new Set(routineNames)].filter(Boolean).sort();
            };

            // Get exercises for the selected routine
            const getRoutineExercises = () => {
                if (!selectedRoutine) return [];
                return routines.filter(r => r.Routine === selectedRoutine);
            };

            // Normalize percentage to 0-100 format
            const normalizePercentage = (pct) => {
                if (pct === null || pct === undefined || pct === '') return null;
                const pctStr = String(pct).toLowerCase().trim();
                if (pctStr === 'warmup' || pctStr.includes('warm')) return 'warmup';
                let num = parseFloat(pctStr.replace('%', ''));
                if (num > 0 && num <= 1) {
                    num = num * 100;
                }
                return Math.round(num);
            };

            // Find matching set for a routine item (returns the set data or null)
            const findMatchingSet = (routineItem) => {
                const today = new Date();
                const todayStr = today.toDateString();

                const routinePct = normalizePercentage(routineItem.Percentage);

                return liftingData.find(set => {
                    // Check if routine matches
                    if (set.Routine !== selectedRoutine) return false;

                    // Check if exercise matches
                    if (set.Exercise !== routineItem.Exercise) return false;

                    // Check if date is today
                    const setDate = new Date(set.Date);
                    if (setDate.toDateString() !== todayStr) return false;

                    // Check if percentage matches
                    const setPct = normalizePercentage(set.Percentage);

                    return routinePct === setPct;
                }) || null;
            };

            // Check if a routine item is completed (has matching set for today)
            const isRoutineItemComplete = (routineItem) => {
                return findMatchingSet(routineItem) !== null;
            };

            // Format percentage for display
            const formatPercentage = (pct) => {
                const normalized = normalizePercentage(pct);
                if (normalized === 'warmup') return 'Warmup';
                if (normalized === null) return '-';
                return `${normalized}%`;
            };

            // Get the most recent completed routine from sets data
            const getLastCompletedRoutine = () => {
                if (!liftingData || liftingData.length === 0) return null;

                // Filter sets that have a routine and sort by date descending
                const setsWithRoutine = liftingData
                    .filter(set => set.Routine)
                    .sort((a, b) => new Date(b.Date) - new Date(a.Date));

                if (setsWithRoutine.length === 0) return null;

                const lastSet = setsWithRoutine[0];
                const lastDate = new Date(lastSet.Date);
                const lastDateStr = lastDate.toDateString();

                // Calculate total weight for that routine on that day
                const totalWeight = liftingData
                    .filter(set => {
                        if (set.Routine !== lastSet.Routine) return false;
                        const setDate = new Date(set.Date);
                        return setDate.toDateString() === lastDateStr;
                    })
                    .reduce((sum, set) => sum + (parseFloat(set.TotalWeight) || 0), 0);

                return {
                    routine: lastSet.Routine,
                    date: lastDate,
                    totalWeight: totalWeight
                };
            };

            const fetchLiftingData = async () => {
                const client = createClient();
                if (!client) return;

                setLoading(true);
                try {
                    const rows = await client.getRows('sets');
                    setLiftingData(rows || []);
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
                setLoading(false);
            };

            // Exercise CRUD operations
            const resetExerciseForm = () => {
                setExerciseForm({
                    Exercise: '',
                    '100pct': '',
                    '90pct': '',
                    '80pct': '',
                    '70pct': '',
                    '60pct': '',
                    Warmup: ''
                });
                setEditingExercise(null);
                setIsAddingExercise(false);
            };

            const startAddExercise = () => {
                resetExerciseForm();
                setIsAddingExercise(true);
            };

            const startEditExercise = (exercise, index) => {
                setExerciseForm({
                    Exercise: exercise.Exercise || '',
                    '100pct': exercise['100pct'] || '',
                    '90pct': exercise['90pct'] || '',
                    '80pct': exercise['80pct'] || '',
                    '70pct': exercise['70pct'] || '',
                    '60pct': exercise['60pct'] || '',
                    Warmup: exercise.Warmup || ''
                });
                setEditingExercise({ ...exercise, _rowIndex: index + 2 }); // +2 because row 1 is headers, index is 0-based
                setIsAddingExercise(false);
            };

            const handleExerciseFormChange = (e) => {
                setExerciseForm({
                    ...exerciseForm,
                    [e.target.name]: e.target.value
                });
            };

            const saveExercise = async () => {
                const client = createClient();
                if (!client) {
                    setStatus('‚ö†Ô∏è Please configure your API settings first');
                    return;
                }

                if (!exerciseForm.Exercise.trim()) {
                    setStatus('‚ö†Ô∏è Exercise name is required');
                    return;
                }

                setStatus('üì§ Saving...');
                try {
                    if (editingExercise) {
                        await client.updateRow('exercises', editingExercise._rowIndex, exerciseForm);
                        setStatus('‚úì Exercise updated!');
                    } else {
                        await client.createRow('exercises', {
                            id: crypto.randomUUID(),
                            ...exerciseForm
                        });
                        setStatus('‚úì Exercise added!');
                    }
                    resetExerciseForm();
                    fetchExercises();
                    setTimeout(() => setStatus(''), 2000);
                } catch (error) {
                    if (error instanceof SheetsDbError) {
                        setStatus(`‚ùå Error: ${error.message}`);
                    } else {
                        setStatus('‚ùå Error saving exercise');
                    }
                    console.error('Save exercise error:', error);
                }
            };

            const deleteExercise = async (exercise, index) => {
                if (!confirm(`Delete "${exercise.Exercise}"?`)) return;

                const client = createClient();
                if (!client) return;

                setStatus('üóëÔ∏è Deleting...');
                try {
                    await client.deleteRow('exercises', index + 2); // +2 for header row and 0-based index
                    setStatus('‚úì Exercise deleted!');
                    fetchExercises();
                    setTimeout(() => setStatus(''), 2000);
                } catch (error) {
                    if (error instanceof SheetsDbError) {
                        setStatus(`‚ùå Error: ${error.message}`);
                    } else {
                        setStatus('‚ùå Error deleting exercise');
                    }
                    console.error('Delete exercise error:', error);
                }
            };

            // Routine CRUD operations
            const resetRoutineForm = () => {
                setRoutineForm({
                    Routine: '',
                    Exercise: '',
                    Percentage: '',
                    Reps: ''
                });
                setEditingRoutineItem(null);
                setIsAddingRoutineItem(false);
                setShowRoutineSuggestions(false);
            };

            // Get filtered routine name suggestions
            const getRoutineNameSuggestions = () => {
                const uniqueNames = [...new Set(routines.map(r => r.Routine).filter(Boolean))];
                if (!routineForm.Routine.trim()) return uniqueNames;
                const searchTerm = routineForm.Routine.toLowerCase();
                return uniqueNames.filter(name =>
                    name.toLowerCase().includes(searchTerm)
                );
            };

            const selectRoutineName = (name) => {
                setRoutineForm({ ...routineForm, Routine: name });
                setShowRoutineSuggestions(false);
            };

            // Get exercises for the routine being edited/added
            const getExercisesForCurrentRoutine = () => {
                if (!routineForm.Routine.trim()) return [];
                const uniqueNames = [...new Set(routines.map(r => r.Routine).filter(Boolean))];
                // Only show if this is an existing routine name
                if (!uniqueNames.includes(routineForm.Routine)) return [];
                return routines.filter(r => r.Routine === routineForm.Routine);
            };

            const startAddRoutineItem = () => {
                resetRoutineForm();
                setIsAddingRoutineItem(true);
            };

            const startEditRoutineItem = (item, index) => {
                setRoutineForm({
                    Routine: item.Routine || '',
                    Exercise: item.Exercise || '',
                    Percentage: item.Percentage || '',
                    Reps: item.Reps || ''
                });
                setEditingRoutineItem({ ...item, _rowIndex: index + 2 });
                setIsAddingRoutineItem(false);
            };

            const handleRoutineFormChange = (e) => {
                setRoutineForm({
                    ...routineForm,
                    [e.target.name]: e.target.value
                });
            };

            const saveRoutineItem = async () => {
                const client = createClient();
                if (!client) {
                    setStatus('‚ö†Ô∏è Please configure your API settings first');
                    return;
                }

                if (!routineForm.Routine.trim() || !routineForm.Exercise.trim()) {
                    setStatus('‚ö†Ô∏è Routine name and exercise are required');
                    return;
                }

                setStatus('üì§ Saving...');
                try {
                    const currentRoutineName = routineForm.Routine;
                    if (editingRoutineItem) {
                        await client.updateRow('routines', editingRoutineItem._rowIndex, routineForm);
                        setStatus('‚úì Routine item updated!');
                        resetRoutineForm();
                    } else {
                        await client.createRow('routines', {
                            id: crypto.randomUUID(),
                            ...routineForm
                        });
                        setStatus('‚úì Routine item added!');
                        // Keep routine name for faster multi-add, clear other fields
                        setRoutineForm({
                            Routine: currentRoutineName,
                            Exercise: '',
                            Percentage: '',
                            Reps: ''
                        });
                        setEditingRoutineItem(null);
                    }
                    fetchRoutines();
                    setTimeout(() => setStatus(''), 2000);
                } catch (error) {
                    if (error instanceof SheetsDbError) {
                        setStatus(`‚ùå Error: ${error.message}`);
                    } else {
                        setStatus('‚ùå Error saving routine item');
                    }
                    console.error('Save routine error:', error);
                }
            };

            const deleteRoutineItem = async (item, index) => {
                if (!confirm(`Delete "${item.Exercise}" from "${item.Routine}"?`)) return;

                const client = createClient();
                if (!client) return;

                setStatus('üóëÔ∏è Deleting...');
                try {
                    await client.deleteRow('routines', index + 2);
                    setStatus('‚úì Routine item deleted!');
                    fetchRoutines();
                    setTimeout(() => setStatus(''), 2000);
                } catch (error) {
                    if (error instanceof SheetsDbError) {
                        setStatus(`‚ùå Error: ${error.message}`);
                    } else {
                        setStatus('‚ùå Error deleting routine item');
                    }
                    console.error('Delete routine error:', error);
                }
            };

            // Weight tracking
            const fetchWeightHistory = async () => {
                const client = createClient();
                if (!client) return;

                try {
                    const rows = await client.getRows('weight');
                    setWeightHistory(rows || []);
                } catch (error) {
                    // Sheet might not exist yet, that's ok
                    console.log('Weight history not available yet');
                    setWeightHistory([]);
                }
            };

            const saveWeight = async () => {
                const client = createClient();
                if (!client) {
                    setStatus('‚ö†Ô∏è Please configure your API settings first');
                    return;
                }

                if (!bodyWeight) {
                    setStatus('‚ö†Ô∏è Please enter a weight');
                    return;
                }

                setStatus('üì§ Saving...');
                try {
                    const now = new Date();
                    const dateStr = `${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')}/${String(now.getFullYear()).slice(-2)}`;
                    const weightData = {
                        id: crypto.randomUUID(),
                        Date: dateStr,
                        Weight: parseFloat(bodyWeight)
                    };

                    await client.createRow('weight', weightData);
                    setStatus('‚úì Weight recorded!');
                    setBodyWeight('');
                    fetchWeightHistory();
                    setTimeout(() => setStatus(''), 2000);
                } catch (error) {
                    if (error instanceof SheetsDbError) {
                        setStatus(`‚ùå Error: ${error.message}`);
                    } else {
                        setStatus('‚ùå Error saving weight');
                    }
                    console.error('Save weight error:', error);
                }
            };

            // Get routines grouped by name
            const getGroupedRoutines = () => {
                const grouped = {};
                routines.forEach((item, index) => {
                    const routineName = item.Routine || 'Unnamed';
                    if (!grouped[routineName]) {
                        grouped[routineName] = [];
                    }
                    grouped[routineName].push({ ...item, _index: index });
                });
                return grouped;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();

                const client = createClient();
                if (!client) {
                    setStatus('‚ö†Ô∏è Please configure your API settings first');
                    return;
                }

                if (!formData.exercise) {
                    setStatus('‚ö†Ô∏è Please select an exercise');
                    return;
                }

                setStatus('üì§ Sending...');

                try {
                    const now = new Date();
                    const dateStr = `${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')}/${String(now.getFullYear()).slice(-2)}`;
                    await client.createRow('sets', {
                        id: crypto.randomUUID(),
                        Date: dateStr,
                        Routine: selectedRoutine,
                        Exercise: formData.exercise,
                        Percentage: formData.percentage,
                        Weight: formData.weight ? parseFloat(formData.weight) : null,
                        Reps: formData.reps ? parseInt(formData.reps) : null,
                        Notes: formData.notes,
                        TotalWeight: formData.weight && formData.reps
                            ? parseFloat(formData.weight) * parseInt(formData.reps)
                            : null
                    });

                    // Update exercise weight if this is a new PR for the percentage
                    if (formData.weight && formData.percentage) {
                        const exerciseIndex = exercises.findIndex(ex => ex.Exercise === formData.exercise);
                        if (exerciseIndex !== -1) {
                            const exercise = exercises[exerciseIndex];
                            const normalizedPct = normalizePercentage(formData.percentage);
                            const pctColumnMap = {
                                100: '100pct',
                                90: '90pct',
                                80: '80pct',
                                70: '70pct',
                                60: '60pct',
                                'warmup': 'Warmup'
                            };
                            const columnName = pctColumnMap[normalizedPct];

                            if (columnName) {
                                const currentWeight = parseFloat(exercise[columnName]) || 0;
                                const newWeight = parseFloat(formData.weight);

                                if (newWeight > currentWeight) {
                                    const now = new Date();
                                    const lastUpdatedStr = `${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')}/${String(now.getFullYear()).slice(-2)}`;
                                    const updatedExercise = {
                                        ...exercise,
                                        [columnName]: newWeight,
                                        LastUpdated: lastUpdatedStr
                                    };
                                    await client.updateRow('exercises', exerciseIndex + 2, updatedExercise);
                                    fetchExercises(); // Refresh exercises data
                                }
                            }
                        }
                    }

                    setStatus('‚úì Submitted successfully!');
                    setFormData({
                        exercise: formData.exercise, // Keep the exercise selected
                        weight: '',
                        percentage: '',
                        reps: '',
                        notes: ''
                    });

                    // Refresh the chart data
                    setTimeout(() => {
                        fetchLiftingData();
                        setStatus('');
                    }, 1000);
                } catch (error) {
                    if (error instanceof SheetsDbError) {
                        setStatus(`‚ùå Error: ${error.message}`);
                    } else {
                        setStatus('‚ùå Error submitting. Check your connection.');
                    }
                    console.error('Submission error:', error);
                }
            };

            const saveSettings = () => {
                localStorage.setItem('liftingSpreadsheetId', spreadsheetId);
                setStatus('‚úì Settings saved!');
                setTimeout(() => setStatus(''), 2000);
            };

            const testConnection = async () => {
                if (!spreadsheetId) {
                    setStatus('‚ö†Ô∏è Please enter a Sheet ID');
                    return;
                }

                setStatus('üîÑ Testing connection...');
                try {
                    const client = new SheetsDbClient({ baseUrl: apiBaseUrl, spreadsheetId });
                    await client.health();
                    const sheets = await client.listSheets();
                    const sheetNames = sheets.map(s => s.title);
                    const requiredNames = Object.keys(REQUIRED_SHEETS);
                    const missing = requiredNames.filter(name => !sheetNames.includes(name));

                    if (missing.length > 0) {
                        setStatus(`‚úì Connected! Found: ${sheetNames.join(', ')}. Missing: ${missing.join(', ')}`);
                    } else {
                        setStatus(`‚úì Connected! All required sheets present: ${requiredNames.join(', ')}`);
                    }
                    setTimeout(() => setStatus(''), 5000);
                } catch (error) {
                    if (error instanceof SheetsDbError) {
                        setStatus(`‚ùå Connection failed: ${error.message}`);
                    } else {
                        setStatus('‚ùå Connection failed. Check your API URL.');
                    }
                }
            };

            const handleInitializeSheets = async () => {
                if (!spreadsheetId) {
                    setStatus('‚ö†Ô∏è Please enter a Sheet ID first');
                    return;
                }
                localStorage.setItem('liftingSpreadsheetId', spreadsheetId);
                await initializeSheets();
                // Refresh data after initialization
                fetchExercises();
                fetchRoutines();
                fetchLiftingData();
                fetchWeightHistory();
            };

            const handleChange = (e) => {
                setFormData({
                    ...formData,
                    [e.target.name]: e.target.value
                });
            };

            // Get weight recommendation for a given exercise and percentage
            const getWeightRecommendationFor = (exercise, percentage) => {
                if (!exercise || !percentage) return null;

                const exerciseData = exercises.find(ex => ex.Exercise === exercise);
                if (!exerciseData) return null;

                // Normalize percentage to match column name
                const normalizedPct = normalizePercentage(percentage);

                // Map percentage to column name
                const pctMap = {
                    100: '100pct',
                    90: '90pct',
                    80: '80pct',
                    70: '70pct',
                    60: '60pct',
                    'warmup': 'Warmup'
                };

                const columnName = pctMap[normalizedPct];
                if (!columnName) return null;

                const currentWeight = parseFloat(exerciseData[columnName]);
                if (isNaN(currentWeight)) return null;

                return {
                    current: currentWeight,
                    recommended: currentWeight + 5
                };
            };

            // Get weight recommendation based on selected exercise and percentage from form
            const getWeightRecommendation = () => {
                return getWeightRecommendationFor(formData.exercise, formData.percentage);
            };

            // Filter data by selected exercise and percentage from form
            const getFilteredData = () => {
                if (!formData.exercise) return [];
                let filtered = liftingData.filter(d => d.Exercise === formData.exercise);
                if (formData.percentage) {
                    filtered = filtered.filter(d => {
                        const formPct = String(formData.percentage).toLowerCase().trim();
                        const entryPctStr = String(d.Percentage).toLowerCase().trim();

                        // Handle warmup case
                        if (formPct === 'warmup') {
                            return entryPctStr === 'warmup' || entryPctStr.includes('warm');
                        }

                        // Skip warmup entries when filtering by number
                        if (entryPctStr === 'warmup' || entryPctStr.includes('warm')) {
                            return false;
                        }

                        // Normalize entry percentage to a number for comparison
                        let entryPct = parseFloat(entryPctStr.replace('%', ''));

                        // Convert decimal to whole number if needed (0.8 -> 80)
                        if (entryPct > 0 && entryPct <= 1) {
                            entryPct = entryPct * 100;
                        }

                        return Math.round(entryPct) === parseInt(formPct);
                    });
                }
                return filtered;
            };

            // Initialize sheets and fetch data on component mount and when spreadsheetId changes
            useEffect(() => {
                const initAndFetch = async () => {
                    if (!spreadsheetId) {
                        setActiveTab('settings');
                        return;
                    }

                    // First, ensure all required sheets exist
                    const result = await initializeSheets();
                    if (result.success) {
                        // Switch to settings if sheets were just created (user needs to know)
                        if (result.created && result.created.length > 0) {
                            setActiveTab('settings');
                        }
                        // Fetch all data
                        fetchExercises();
                        fetchRoutines();
                        fetchLiftingData();
                        fetchWeightHistory();
                    } else {
                        // If initialization failed, go to settings
                        setActiveTab('settings');
                    }
                };
                initAndFetch();
            }, [spreadsheetId]);

            // Update chart when data changes or when switching to chart view
            useEffect(() => {
                if (progressView === 'chart' && chartRef.current && formData.exercise) {
                    const filteredData = getFilteredData();

                    if (filteredData.length === 0) {
                        if (chartInstance.current) {
                            chartInstance.current.destroy();
                            chartInstance.current = null;
                        }
                        return;
                    }

                    // Prepare data for chart
                    const labels = filteredData.map(d => {
                        const date = new Date(d.Date);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    });
                    const weights = filteredData.map(d => parseFloat(d.Weight) || 0);

                    // Check if chart exists and is still attached to the current canvas
                    const chartExists = chartInstance.current && chartInstance.current.canvas === chartRef.current;

                    if (chartExists) {
                        // Update existing chart
                        chartInstance.current.data.labels = labels;
                        chartInstance.current.data.datasets[0].data = weights;
                        chartInstance.current.data.datasets[0].label = `${formData.exercise} Weight (lbs)`;
                        chartInstance.current.update();
                    } else {
                        // Destroy old chart if it exists but is detached
                        if (chartInstance.current) {
                            chartInstance.current.destroy();
                        }

                        // Create new chart
                        const ctx = chartRef.current.getContext('2d');
                        chartInstance.current = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: `${formData.exercise} Weight (lbs)`,
                                    data: weights,
                                    borderColor: 'rgb(79, 70, 229)',
                                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                    tension: 0.3,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        ticks: {
                                            callback: function(value) {
                                                return value + ' lbs';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            }, [liftingData, progressView, formData.exercise, formData.percentage]);

            // Update weight chart when data changes
            useEffect(() => {
                if (activeTab === 'weight' && weightChartRef.current && weightHistory.length > 0) {
                    // Sort by date
                    const sortedData = [...weightHistory].sort((a, b) => {
                        const dateA = new Date(a.Date);
                        const dateB = new Date(b.Date);
                        return dateA - dateB;
                    });

                    const labels = sortedData.map(d => {
                        const date = new Date(d.Date);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    });
                    const weights = sortedData.map(d => parseFloat(d.Weight) || 0);

                    const chartExists = weightChartInstance.current && weightChartInstance.current.canvas === weightChartRef.current;

                    if (chartExists) {
                        weightChartInstance.current.data.labels = labels;
                        weightChartInstance.current.data.datasets[0].data = weights;
                        weightChartInstance.current.update();
                    } else {
                        if (weightChartInstance.current) {
                            weightChartInstance.current.destroy();
                        }

                        const ctx = weightChartRef.current.getContext('2d');
                        weightChartInstance.current = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Body Weight (lbs)',
                                    data: weights,
                                    borderColor: 'rgb(34, 197, 94)',
                                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                    tension: 0.3,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        ticks: {
                                            callback: function(value) {
                                                return value + ' lbs';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                } else if (activeTab !== 'weight' && weightChartInstance.current) {
                    // Clean up chart when leaving the tab
                    weightChartInstance.current.destroy();
                    weightChartInstance.current = null;
                }
            }, [weightHistory, activeTab]);

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-md mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl p-6 mt-8">
                            <div className="flex items-center gap-3 mb-6">
                                <div className="bg-indigo-600 p-3 rounded-xl">
                                    <Dumbbell size={24} className="text-white" />
                                </div>
                                <h1 className="text-2xl font-bold text-gray-800">Lifting Tracker</h1>
                            </div>

                            {!spreadsheetId && (
                                <div className="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                    <p className="text-sm text-amber-800 font-medium mb-3">‚öôÔ∏è Setup Required</p>
                                    <ol className="list-decimal list-inside space-y-2 text-xs text-amber-700">
                                        <li>Create a new Google Sheet</li>
                                        <li>Share it with:<br/>
                                            <code className="block mt-1 p-2 bg-amber-100 rounded text-xs break-all select-all text-amber-800">
                                                sheets-db-api@kinetic-object-322814.iam.gserviceaccount.com
                                            </code>
                                            <span className="text-amber-600">(Editor access)</span>
                                        </li>
                                        <li>Copy the Sheet ID from the URL</li>
                                        <li>Paste below and click "Connect"</li>
                                    </ol>
                                    <div className="mt-4">
                                        <input
                                            type="text"
                                            value={setupInputId}
                                            onChange={(e) => setSetupInputId(e.target.value)}
                                            placeholder="Paste your Google Sheet ID here"
                                            className="w-full px-3 py-2 border border-amber-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                        />
                                        <button
                                            type="button"
                                            onClick={async () => {
                                                if (!setupInputId) {
                                                    setStatus('‚ö†Ô∏è Please enter a Sheet ID');
                                                    return;
                                                }
                                                localStorage.setItem('liftingSpreadsheetId', setupInputId);
                                                setSpreadsheetId(setupInputId);
                                                setSetupInputId('');
                                            }}
                                            disabled={!setupInputId || initializing}
                                            className="w-full mt-2 px-3 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {initializing ? 'Initializing...' : 'Connect'}
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Tab Navigation - only show when setup is complete */}
                            {spreadsheetId && (
                            <div className="flex gap-1 mb-6 border-b border-gray-200 overflow-x-auto scrollbar-hide -mx-2 px-2" style={{scrollbarWidth: 'none', msOverflowStyle: 'none', WebkitOverflowScrolling: 'touch'}}>
                                <button
                                    onClick={() => {
                                        setActiveTab('track');
                                        fetchLiftingData();
                                    }}
                                    className={`px-3 py-2 font-medium text-sm transition-colors whitespace-nowrap flex-shrink-0 ${
                                        activeTab === 'track'
                                            ? 'text-indigo-600 border-b-2 border-indigo-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Track Lift
                                </button>
                                <button
                                    onClick={() => {
                                        setActiveTab('exercises');
                                        fetchExercises();
                                    }}
                                    className={`px-3 py-2 font-medium text-sm transition-colors whitespace-nowrap flex-shrink-0 ${
                                        activeTab === 'exercises'
                                            ? 'text-indigo-600 border-b-2 border-indigo-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Exercises
                                </button>
                                <button
                                    onClick={() => {
                                        setActiveTab('routines');
                                        fetchRoutines();
                                    }}
                                    className={`px-3 py-2 font-medium text-sm transition-colors whitespace-nowrap flex-shrink-0 ${
                                        activeTab === 'routines'
                                            ? 'text-indigo-600 border-b-2 border-indigo-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Routines
                                </button>
                                <button
                                    onClick={() => {
                                        setActiveTab('weight');
                                        fetchWeightHistory();
                                    }}
                                    className={`px-3 py-2 font-medium text-sm transition-colors whitespace-nowrap flex-shrink-0 ${
                                        activeTab === 'weight'
                                            ? 'text-indigo-600 border-b-2 border-indigo-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Weight
                                </button>
                                <button
                                    onClick={() => {
                                        setActiveTab('settings');
                                    }}
                                    className={`px-3 py-2 font-medium text-sm transition-colors whitespace-nowrap flex-shrink-0 ${
                                        activeTab === 'settings'
                                            ? 'text-indigo-600 border-b-2 border-indigo-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Settings
                                </button>
                            </div>
                            )}

                            {/* Tab Content - only show when setup is complete */}
                            {spreadsheetId && activeTab === 'track' && (
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Routine
                                        </label>
                                        <select
                                            value={selectedRoutine}
                                            onChange={(e) => setSelectedRoutine(e.target.value)}
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg bg-white"
                                        >
                                            <option value="">Select a routine...</option>
                                            {getUniqueRoutines().map(routine => (
                                                <option key={routine} value={routine}>{routine}</option>
                                            ))}
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Exercise *
                                        </label>
                                        <select
                                            name="exercise"
                                            value={formData.exercise}
                                            onChange={handleChange}
                                            required
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg bg-white"
                                        >
                                            <option value="">Select an exercise...</option>
                                            {exercises.map(ex => (
                                                <option key={ex.Exercise} value={ex.Exercise}>{ex.Exercise}</option>
                                            ))}
                                        </select>
                                    </div>

                                    <div className="grid grid-cols-3 gap-3">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Weight (lbs)
                                            </label>
                                            <input
                                                type="number"
                                                name="weight"
                                                value={formData.weight}
                                                onChange={handleChange}
                                                step="0.5"
                                                className="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg"
                                                placeholder="225"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Percentage
                                            </label>
                                            <select
                                                name="percentage"
                                                value={formData.percentage}
                                                onChange={handleChange}
                                                className="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg bg-white"
                                            >
                                                <option value="">Select...</option>
                                                <option value="100">100%</option>
                                                <option value="90">90%</option>
                                                <option value="80">80%</option>
                                                <option value="70">70%</option>
                                                <option value="60">60%</option>
                                                <option value="warmup">Warmup</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Reps
                                            </label>
                                            <input
                                                type="number"
                                                name="reps"
                                                value={formData.reps}
                                                onChange={handleChange}
                                                min="1"
                                                step="1"
                                                className="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg"
                                                placeholder="5"
                                            />
                                        </div>
                                    </div>

                                    {getWeightRecommendation() && (
                                        <div className="p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
                                            <p className="text-sm text-indigo-800">
                                                <span className="font-medium">Recommended:</span> {getWeightRecommendation().recommended} lbs
                                                <span className="text-indigo-600 ml-2">(Current: {getWeightRecommendation().current} lbs)</span>
                                            </p>
                                        </div>
                                    )}

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Notes
                                        </label>
                                        <input
                                            type="text"
                                            name="notes"
                                            value={formData.notes}
                                            onChange={handleChange}
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg"
                                            placeholder="Optional notes..."
                                        />
                                    </div>

                                    {status && (
                                        <div className={`p-3 rounded-lg text-sm font-medium ${
                                            status.includes('‚úì')
                                                ? 'bg-green-50 text-green-800'
                                                : status.includes('‚ùå') || status.includes('‚ö†Ô∏è')
                                                ? 'bg-red-50 text-red-800'
                                                : 'bg-blue-50 text-blue-800'
                                        }`}>
                                            {status}
                                        </div>
                                    )}

                                    <button
                                        type="submit"
                                        className="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <Send size={18} />
                                        Submit
                                    </button>
                                </form>
                            )}

                            {/* Exercises Tab */}
                            {spreadsheetId && activeTab === 'exercises' && (
                                <div className="space-y-4">
                                    {/* Add/Edit Form */}
                                    {(isAddingExercise || editingExercise) && (
                                        <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                            <h3 className="font-medium text-gray-800 mb-3">
                                                {editingExercise ? 'Edit Exercise' : 'Add New Exercise'}
                                            </h3>
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Exercise Name *
                                                    </label>
                                                    <input
                                                        type="text"
                                                        name="Exercise"
                                                        value={exerciseForm.Exercise}
                                                        onChange={handleExerciseFormChange}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                        placeholder="e.g., Bench Press"
                                                    />
                                                </div>
                                                <div className="grid grid-cols-3 gap-2">
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1">100%</label>
                                                        <input
                                                            type="number"
                                                            name="100pct"
                                                            value={exerciseForm['100pct']}
                                                            onChange={handleExerciseFormChange}
                                                            className="w-full px-2 py-2 border border-gray-300 rounded-lg text-sm"
                                                            placeholder="lbs"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1">90%</label>
                                                        <input
                                                            type="number"
                                                            name="90pct"
                                                            value={exerciseForm['90pct']}
                                                            onChange={handleExerciseFormChange}
                                                            className="w-full px-2 py-2 border border-gray-300 rounded-lg text-sm"
                                                            placeholder="lbs"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1">80%</label>
                                                        <input
                                                            type="number"
                                                            name="80pct"
                                                            value={exerciseForm['80pct']}
                                                            onChange={handleExerciseFormChange}
                                                            className="w-full px-2 py-2 border border-gray-300 rounded-lg text-sm"
                                                            placeholder="lbs"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1">70%</label>
                                                        <input
                                                            type="number"
                                                            name="70pct"
                                                            value={exerciseForm['70pct']}
                                                            onChange={handleExerciseFormChange}
                                                            className="w-full px-2 py-2 border border-gray-300 rounded-lg text-sm"
                                                            placeholder="lbs"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1">60%</label>
                                                        <input
                                                            type="number"
                                                            name="60pct"
                                                            value={exerciseForm['60pct']}
                                                            onChange={handleExerciseFormChange}
                                                            className="w-full px-2 py-2 border border-gray-300 rounded-lg text-sm"
                                                            placeholder="lbs"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1">Warmup</label>
                                                        <input
                                                            type="number"
                                                            name="Warmup"
                                                            value={exerciseForm.Warmup}
                                                            onChange={handleExerciseFormChange}
                                                            className="w-full px-2 py-2 border border-gray-300 rounded-lg text-sm"
                                                            placeholder="lbs"
                                                        />
                                                    </div>
                                                </div>
                                                <div className="flex gap-2 pt-2">
                                                    <button
                                                        type="button"
                                                        onClick={saveExercise}
                                                        className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium"
                                                    >
                                                        {editingExercise ? 'Update' : 'Add'}
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={resetExerciseForm}
                                                        className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium"
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Add Button */}
                                    {!isAddingExercise && !editingExercise && (
                                        <button
                                            type="button"
                                            onClick={startAddExercise}
                                            className="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium"
                                        >
                                            + Add Exercise
                                        </button>
                                    )}

                                    {/* Exercise List */}
                                    <div className="space-y-2">
                                        {exercises.length === 0 ? (
                                            <p className="text-center text-gray-500 py-4">No exercises yet. Add one above!</p>
                                        ) : (
                                            exercises.map((exercise, index) => (
                                                <div
                                                    key={exercise.id || index}
                                                    className="p-3 bg-white border border-gray-200 rounded-lg"
                                                >
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex-1">
                                                            <p className="font-medium text-gray-800">{exercise.Exercise}</p>
                                                            <p className="text-xs text-gray-500 mt-1">
                                                                {exercise['100pct'] && `100%: ${exercise['100pct']}`}
                                                                {exercise['90pct'] && ` ¬∑ 90%: ${exercise['90pct']}`}
                                                                {exercise['80pct'] && ` ¬∑ 80%: ${exercise['80pct']}`}
                                                                {exercise.Warmup && ` ¬∑ Warmup: ${exercise.Warmup}`}
                                                            </p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                type="button"
                                                                onClick={() => startEditExercise(exercise, index)}
                                                                className="px-3 py-1 text-indigo-600 hover:bg-indigo-50 rounded text-sm font-medium"
                                                            >
                                                                Edit
                                                            </button>
                                                            <button
                                                                type="button"
                                                                onClick={() => deleteExercise(exercise, index)}
                                                                className="px-3 py-1 text-red-600 hover:bg-red-50 rounded text-sm font-medium"
                                                            >
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    {status && (
                                        <div className={`p-3 rounded-lg text-sm font-medium ${
                                            status.includes('‚úì')
                                                ? 'bg-green-50 text-green-800'
                                                : status.includes('‚ùå') || status.includes('‚ö†Ô∏è')
                                                ? 'bg-red-50 text-red-800'
                                                : 'bg-blue-50 text-blue-800'
                                        }`}>
                                            {status}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Routines Tab */}
                            {spreadsheetId && activeTab === 'routines' && (
                                <div className="space-y-4">
                                    {/* Add/Edit Form - Always visible */}
                                    <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                            <h3 className="font-medium text-gray-800 mb-3">
                                                {editingRoutineItem ? 'Edit Routine Item' : 'Add Routine Item'}
                                            </h3>
                                            <div className="space-y-3">
                                                <div className="relative">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Routine Name *
                                                    </label>
                                                    <input
                                                        type="text"
                                                        name="Routine"
                                                        value={routineForm.Routine}
                                                        onChange={(e) => {
                                                            handleRoutineFormChange(e);
                                                            setShowRoutineSuggestions(true);
                                                        }}
                                                        onFocus={() => setShowRoutineSuggestions(true)}
                                                        onBlur={() => setTimeout(() => setShowRoutineSuggestions(false), 150)}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                        placeholder="e.g., Push Day"
                                                        autoComplete="off"
                                                    />
                                                    {showRoutineSuggestions && getRoutineNameSuggestions().length > 0 && (
                                                        <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto">
                                                            {getRoutineNameSuggestions().map((name, idx) => (
                                                                <button
                                                                    key={idx}
                                                                    type="button"
                                                                    onClick={() => selectRoutineName(name)}
                                                                    className="w-full px-3 py-2 text-left hover:bg-indigo-50 text-sm text-gray-800"
                                                                >
                                                                    {name}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Exercise *
                                                    </label>
                                                    <select
                                                        name="Exercise"
                                                        value={routineForm.Exercise}
                                                        onChange={handleRoutineFormChange}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white"
                                                    >
                                                        <option value="">Select an exercise...</option>
                                                        {exercises.map(ex => (
                                                            <option key={ex.Exercise} value={ex.Exercise}>{ex.Exercise}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                                            Percentage
                                                        </label>
                                                        <select
                                                            name="Percentage"
                                                            value={routineForm.Percentage}
                                                            onChange={handleRoutineFormChange}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white"
                                                        >
                                                            <option value="">Select...</option>
                                                            <option value="100">100%</option>
                                                            <option value="90">90%</option>
                                                            <option value="80">80%</option>
                                                            <option value="70">70%</option>
                                                            <option value="60">60%</option>
                                                            <option value="warmup">Warmup</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                                            Reps
                                                        </label>
                                                        <input
                                                            type="number"
                                                            name="Reps"
                                                            value={routineForm.Reps}
                                                            onChange={handleRoutineFormChange}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                            placeholder="5"
                                                        />
                                                    </div>
                                                </div>
                                                <div className="flex gap-2 pt-2">
                                                    <button
                                                        type="button"
                                                        onClick={saveRoutineItem}
                                                        className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium"
                                                    >
                                                        {editingRoutineItem ? 'Update' : 'Add'}
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={resetRoutineForm}
                                                        className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium"
                                                    >
                                                        {editingRoutineItem ? 'Cancel' : 'Clear'}
                                                    </button>
                                                </div>

                                                {/* Show exercises in this routine */}
                                                {getExercisesForCurrentRoutine().length > 0 && (
                                                    <div className="mt-4 pt-4 border-t border-gray-200">
                                                        <p className="text-xs font-medium text-gray-500 mb-2">
                                                            Exercises in "{routineForm.Routine}":
                                                        </p>
                                                        <div className="space-y-1">
                                                            {getExercisesForCurrentRoutine().map((item, idx) => (
                                                                <div
                                                                    key={item.id || idx}
                                                                    className="flex items-center justify-between py-1 px-2 bg-white rounded text-sm"
                                                                >
                                                                    <span className="text-gray-800">{item.Exercise}</span>
                                                                    <span className="text-gray-500 text-xs">
                                                                        {item.Percentage && (
                                                                            item.Percentage === 'warmup' || item.Percentage === 'Warmup'
                                                                                ? 'Warmup'
                                                                                : `${item.Percentage}%`
                                                                        )}
                                                                        {item.Reps && ` ¬∑ ${item.Reps} reps`}
                                                                    </span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                    {status && (
                                        <div className={`p-3 rounded-lg text-sm font-medium ${
                                            status.includes('‚úì')
                                                ? 'bg-green-50 text-green-800'
                                                : status.includes('‚ùå') || status.includes('‚ö†Ô∏è')
                                                ? 'bg-red-50 text-red-800'
                                                : 'bg-blue-50 text-blue-800'
                                        }`}>
                                            {status}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Weight Tab */}
                            {spreadsheetId && activeTab === 'weight' && (
                                <div className="space-y-4">
                                    <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                        <h3 className="font-medium text-gray-800 mb-3">Log Body Weight</h3>
                                        <div className="space-y-3">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Weight (lbs)
                                                </label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    value={bodyWeight}
                                                    onChange={(e) => setBodyWeight(e.target.value)}
                                                    className="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg"
                                                    placeholder="199.9"
                                                />
                                            </div>
                                            <button
                                                type="button"
                                                onClick={saveWeight}
                                                className="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium"
                                            >
                                                Record Weight
                                            </button>
                                        </div>
                                    </div>

                                    {/* Weight History Chart */}
                                    {weightHistory.length > 0 && (
                                        <div className="p-4 bg-white rounded-lg border border-gray-200">
                                            <h3 className="font-medium text-gray-800 mb-3">Weight History</h3>
                                            <div className="h-48">
                                                <canvas ref={weightChartRef}></canvas>
                                            </div>
                                        </div>
                                    )}

                                    {weightHistory.length === 0 && (
                                        <div className="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center">
                                            <p className="text-gray-500 text-sm">No weight history yet. Record your first weight above!</p>
                                        </div>
                                    )}

                                    {status && (
                                        <div className={`p-3 rounded-lg text-sm font-medium ${
                                            status.includes('‚úì')
                                                ? 'bg-green-50 text-green-800'
                                                : status.includes('‚ùå') || status.includes('‚ö†Ô∏è')
                                                ? 'bg-red-50 text-red-800'
                                                : 'bg-blue-50 text-blue-800'
                                        }`}>
                                            {status}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Settings Tab */}
                            {spreadsheetId && activeTab === 'settings' && (
                                <div className="space-y-6">
                                    {editingSettings ? (
                                        /* Editing mode */
                                        <>
                                            <p className="text-sm text-gray-800 font-medium">Change Spreadsheet</p>
                                            <p className="text-xs text-gray-500">
                                                Make sure to share the new spreadsheet with:<br/>
                                                <code className="block mt-1 p-2 bg-gray-100 rounded text-xs break-all select-all">
                                                    sheets-db-api@kinetic-object-322814.iam.gserviceaccount.com
                                                </code>
                                            </p>
                                            <div>
                                                <input
                                                    type="text"
                                                    value={tempSpreadsheetId}
                                                    onChange={(e) => setTempSpreadsheetId(e.target.value)}
                                                    placeholder="Paste your Google Sheet ID here"
                                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                                                />
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        setEditingSettings(false);
                                                        setTempSpreadsheetId('');
                                                    }}
                                                    className="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium"
                                                >
                                                    Cancel
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={async () => {
                                                        if (!tempSpreadsheetId) {
                                                            setStatus('‚ö†Ô∏è Please enter a Sheet ID');
                                                            return;
                                                        }
                                                        localStorage.setItem('liftingSpreadsheetId', tempSpreadsheetId);
                                                        setSpreadsheetId(tempSpreadsheetId);
                                                        setEditingSettings(false);
                                                        setTempSpreadsheetId('');
                                                        // Trigger initialization
                                                        await initializeSheets();
                                                        fetchExercises();
                                                        fetchRoutines();
                                                        fetchLiftingData();
                                                        fetchWeightHistory();
                                                    }}
                                                    disabled={initializing || !tempSpreadsheetId}
                                                    className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                                                >
                                                    {initializing ? 'Initializing...' : 'Save & Initialize'}
                                                </button>
                                            </div>
                                        </>
                                    ) : (
                                        /* Connected state */
                                        <>
                                            <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                                                <p className="text-sm text-green-800 font-medium mb-2">‚úì Connected</p>
                                                <a
                                                    href={`https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="text-sm text-green-700 hover:text-green-900 underline break-all"
                                                >
                                                    Open Spreadsheet
                                                </a>
                                            </div>
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    setTempSpreadsheetId(spreadsheetId);
                                                    setEditingSettings(true);
                                                }}
                                                className="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium"
                                            >
                                                Change Spreadsheet
                                            </button>
                                        </>
                                    )}

                                    {status && (
                                        <div className={`p-3 rounded-lg text-sm font-medium ${
                                            status.includes('‚úì')
                                                ? 'bg-green-50 text-green-800'
                                                : status.includes('‚ùå') || status.includes('‚ö†Ô∏è')
                                                ? 'bg-red-50 text-red-800'
                                                : 'bg-blue-50 text-blue-800'
                                        }`}>
                                            {status}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {activeTab === 'track' && formData.exercise && getFilteredData().length > 0 && (
                            <div className="bg-white rounded-2xl shadow-xl p-6 mt-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-xl font-bold text-gray-800">{formData.exercise} Progress</h2>
                                    <button
                                        onClick={fetchLiftingData}
                                        disabled={loading}
                                        className="p-2 bg-indigo-100 text-indigo-600 rounded-lg hover:bg-indigo-200 transition-colors disabled:opacity-50"
                                        title="Refresh data"
                                    >
                                        <RefreshCw size={18} className={loading ? 'animate-spin' : ''} />
                                    </button>
                                </div>

                                {/* Progress View Tabs */}
                                <div className="flex gap-2 mb-4 border-b border-gray-200">
                                    <button
                                        onClick={() => {
                                            setProgressView('chart');
                                            fetchLiftingData();
                                        }}
                                        className={`px-4 py-2 font-medium text-sm transition-colors ${
                                            progressView === 'chart'
                                                ? 'text-indigo-600 border-b-2 border-indigo-600'
                                                : 'text-gray-600 hover:text-gray-800'
                                        }`}
                                    >
                                        Chart
                                    </button>
                                    <button
                                        onClick={() => {
                                            setProgressView('table');
                                            fetchLiftingData();
                                        }}
                                        className={`px-4 py-2 font-medium text-sm transition-colors ${
                                            progressView === 'table'
                                                ? 'text-indigo-600 border-b-2 border-indigo-600'
                                                : 'text-gray-600 hover:text-gray-800'
                                        }`}
                                    >
                                        Table
                                    </button>
                                </div>

                                {/* Chart View */}
                                {progressView === 'chart' && (
                                    <div style={{ height: '300px' }}>
                                        <canvas ref={chartRef}></canvas>
                                    </div>
                                )}

                                {/* Table View */}
                                {progressView === 'table' && (
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="border-b border-gray-200">
                                                    <th className="text-left py-3 px-2 font-semibold text-gray-700 whitespace-nowrap">Date</th>
                                                    <th className="text-right py-3 px-2 font-semibold text-gray-700 whitespace-nowrap">Percentage</th>
                                                    <th className="text-right py-3 px-2 font-semibold text-gray-700 whitespace-nowrap">Weight (lbs)</th>
                                                    <th className="text-right py-3 px-2 font-semibold text-gray-700 whitespace-nowrap">Reps</th>
                                                    <th className="text-left py-3 px-2 font-semibold text-gray-700 whitespace-nowrap">Notes</th>
                                                    <th className="text-right py-3 px-2 font-semibold text-gray-700 whitespace-nowrap">Total Weight</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {getFilteredData().slice().reverse().map((entry, index) => {
                                                    const date = new Date(entry.Date);
                                                    return (
                                                        <tr key={index} className="border-b border-gray-100 hover:bg-gray-50">
                                                            <td className="py-3 px-2 text-gray-800">
                                                                {date.toLocaleDateString('en-US', {
                                                                    month: 'short',
                                                                    day: 'numeric'
                                                                })}
                                                            </td>
                                                            <td className="py-3 px-2 text-right text-gray-600">
                                                                {entry.Percentage ? (
                                                                    String(entry.Percentage).toLowerCase() === 'warmup'
                                                                        ? 'Warmup'
                                                                        : `${entry.Percentage <= 1 ? Math.round(entry.Percentage * 100) : entry.Percentage}%`
                                                                ) : '-'}
                                                            </td>
                                                            <td className="py-3 px-2 text-right text-gray-800">
                                                                {entry.Weight ? `${entry.Weight}` : '-'}
                                                            </td>
                                                            <td className="py-3 px-2 text-right text-gray-600">
                                                                {entry.Reps || '-'}
                                                            </td>
                                                            <td className="py-3 px-2 text-gray-600 text-xs">
                                                                {entry.Notes || '-'}
                                                            </td>
                                                            <td className="py-3 px-2 text-right text-gray-800">
                                                                {entry.TotalWeight || '-'}
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Routine Checklist Card */}
                        {activeTab === 'track' && !selectedRoutine && getLastCompletedRoutine() && (
                            <div className="bg-white rounded-2xl shadow-xl p-6 mt-6">
                                <p className="text-sm text-gray-600">Last completed routine:</p>
                                <p className="text-lg font-bold text-gray-800">{getLastCompletedRoutine().routine}</p>
                                <div className="flex justify-between items-center mt-1">
                                    <p className="text-sm text-gray-500">
                                        {getLastCompletedRoutine().date.toLocaleDateString('en-US', {
                                            weekday: 'long',
                                            month: 'short',
                                            day: 'numeric'
                                        })}
                                    </p>
                                    <p className="text-sm font-medium text-indigo-600">
                                        üí™ {getLastCompletedRoutine().totalWeight.toLocaleString()} lbs total
                                    </p>
                                </div>
                            </div>
                        )}

                        {activeTab === 'track' && selectedRoutine && getRoutineExercises().length > 0 && (
                            <div className="bg-white rounded-2xl shadow-xl p-6 mt-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">{selectedRoutine}</h2>
                                <div className="space-y-2">
                                    {getRoutineExercises().map((item, index) => {
                                        const matchingSet = findMatchingSet(item);
                                        const isComplete = matchingSet !== null;
                                        const recommendation = !isComplete ? getWeightRecommendationFor(item.Exercise, item.Percentage) : null;
                                        return (
                                            <div
                                                key={index}
                                                className={`flex items-center gap-3 p-3 rounded-lg border ${
                                                    isComplete
                                                        ? 'bg-green-50 border-green-200'
                                                        : 'bg-gray-50 border-gray-200'
                                                }`}
                                            >
                                                <div className={`flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                                                    isComplete
                                                        ? 'bg-green-500 border-green-500'
                                                        : 'border-gray-300'
                                                }`}>
                                                    {isComplete && (
                                                        <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
                                                        </svg>
                                                    )}
                                                </div>
                                                <div className="flex-1">
                                                    <p className={`font-medium ${isComplete ? 'text-green-800' : 'text-gray-800'}`}>
                                                        {item.Exercise}
                                                    </p>
                                                    <p className={`text-sm ${isComplete ? 'text-green-600' : 'text-gray-600'}`}>
                                                        {formatPercentage(item.Percentage)} ¬∑ {item.Reps} reps
                                                        {isComplete && matchingSet.Weight && (
                                                            <span className="font-medium"> ¬∑ {matchingSet.Weight} lbs</span>
                                                        )}
                                                    </p>
                                                    {!isComplete && recommendation && (
                                                        <p className="text-xs text-indigo-600 mt-1">
                                                            Recommended: {recommendation.recommended} lbs (Current: {recommendation.current} lbs)
                                                        </p>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {loading && (
                            <div className="text-center mt-6 text-sm text-gray-600">
                                <p>Loading data...</p>
                            </div>
                        )}

                        <div className="text-center mt-6 text-sm text-gray-600">
                            <p>üí° Tip: Add this page to your home screen for quick access</p>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LiftingTracker />);
    </script>
</body>
</html>
